<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<changeSet id="create plan" author="wj">
		<createTable tableName="plan" remarks="represents a year, semester, or quarter">
			<column name="id" type="int">
				<constraints primaryKey="true" nullable="false" primaryKeyName="pk_semester"/>
			</column>
			<column name="name" type="varchar(50)" remarks="i.e. school name 2015-1">
				<constraints nullable="false"/>
			</column>
			<column name="effective_on" type="date"/>
			<column name="expires_on" type="date"/>
			<column name="dirty" type="char(1)" defaultValue="Y" remarks="some element of the plan has changed since the schedule was generated"/>
			<column name="role" type="varchar(50)" remarks="the role requires to view/edit this plan"/>
		</createTable>
	</changeSet>
	
	<changeSet id="create block" author="wj">
		<createTable tableName="block" remarks="the blocks for the plan">
			<column name="id" type="int">
				<constraints primaryKey="true" nullable="false" primaryKeyName="pk_block"/>
			</column>
			<column name="plan_id" type="int">
				<constraints foreignKeyName="fk_block_plan" references="plan(id)"/>
			</column>
			<column name="name" type="varchar(50)" remarks="i.e. MWF 830">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>
	
	<changeSet id="create room" author="wj">
		<createTable tableName="room" remarks="the rooms for the plan">
			<column name="id" type="int">
				<constraints primaryKey="true" nullable="false" primaryKeyName="pk_room"/>
			</column>
			<column name="plan_id" type="int">
				<constraints foreignKeyName="fk_room_plan" references="plan(id)"/>
			</column>
			<column name="name" type="varchar(50)">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>
	
	<changeSet id="create teacher" author="wj">
		<createTable tableName="teacher" remarks="the teachers for the plan">
			<column name="id" type="int">
				<constraints primaryKey="true" nullable="false" primaryKeyName="pk_teacher"/>
			</column>
			<column name="plan_id" type="int">
				<constraints foreignKeyName="fk_teacher_plan" references="plan(id)"/>
			</column>
			<column name="name" type="varchar(50)">
				<constraints nullable="false"/>
			</column>
			<column name="min_blocks" type="smallint" remarks="minimum allocation in blocks (i.e. 6)"/>
			<column name="max_blocks" type="smallint" remarks="maximum allocation in blocks (i.e. 8)"/>
		</createTable>
	</changeSet>
	
	<changeSet id="create class" author="wj">
		<createTable tableName="class" remarks="the classes in a plan">
			<column name="id" type="int">
				<constraints primaryKey="true" nullable="false" primaryKeyName="pk_class"/>
			</column>
			<column name="plan_id" type="int">
				<constraints foreignKeyName="fk_class_plan" references="plan(id)"/>
			</column>
			<column name="name" type="varchar(50)">
				<constraints nullable="false"/>
			</column>
			<column name="grade" type="smallint"/>
			<column name="num_blocks" type="smallint" remarks="number of blocks to occupy (i.e. 1)"/>
		</createTable>
	</changeSet>
	
	<changeSet id="create student" author="wj">
		<createTable tableName="student" remarks="the studends in a plan">
			<column name="id" type="int">
				<constraints primaryKey="true" nullable="false" primaryKeyName="pk_student"/>
			</column>
			<column name="plan_id" type="int">
				<constraints foreignKeyName="fk_student_plan" references="plan(id)"/>
			</column>
			<column name="name" type="varchar(50)">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>
	
	<changeSet id="create teacher_class" author="wj">
		<createTable tableName="teacher_class" remarks="the classes a teacher can teach">
			<column name="teacher_id" type="int">
				<constraints foreignKeyName="fk_teacher_class_teacher" references="teacher(id)"/>
			</column>
			<column name="class_id" type="int">
				<constraints foreignKeyName="fk_teaches_class_class" references="class(id)"/>
			</column>
		</createTable>
	</changeSet>
	
	<changeSet id="create room_class" author="wj">
		<createTable tableName="teacher_class" remarks="the classes a room can accommodate">
			<column name="room_id" type="int">
				<constraints foreignKeyName="fk_room_class_room" references="room(id)"/>
			</column>
			<column name="class_id" type="int">
				<constraints foreignKeyName="fk_room_class_class" references="class(id)"/>
			</column>
		</createTable>
	</changeSet>
	
	<changeSet id="create fixture" author="wj">
		<createTable tableName="schedule" remarks="the fixed elements of a schedule for a plan">
			<column name="block_id">
				<constraints foreignKeyName="fk_schedule_block" references="block(id)"/>
			</column>
			<column name="class_id">
				<constraints foreignKeyName="fk_schedule_class" references="class(id)"/>
			</column>
			<column name="room_id">
				<constraints foreignKeyName="fk_schedule_room" references="room(id)"/>
			</column>
			<column name="teacher_id">
				<constraints foreignKeyName="fk_schedule_teacher" references="teacher(id)"/>
			</column>
		</createTable>
	</changeSet>
	
	<changeSet id="create schedule" author="wj">
		<createTable tableName="schedule" remarks="the schedule for a plan">
			<column name="block_id">
				<constraints foreignKeyName="fk_schedule_block" references="block(id)"/>
			</column>
			<column name="class_id">
				<constraints foreignKeyName="fk_schedule_class" references="class(id)"/>
			</column>
			<column name="room_id">
				<constraints foreignKeyName="fk_schedule_room" references="room(id)"/>
			</column>
			<column name="teacher_id">
				<constraints foreignKeyName="fk_schedule_teacher" references="teacher(id)"/>
			</column>
		</createTable>
	</changeSet>
	
	<changeSet id="create schedule_student" author="wj">
		<createTable tableName="schedule_student">
			<column name="schedule_id">
				<constraints foreignKeyName="fk_schedule_student_schedule" references="schedule(id)"/>
			</column>
			<column name="student_id">
				<constraints foreignKeyName="fk_schedule_student_student" references="student(id)"/>
			</column>
		</createTable>
	</changeSet>
	
	<changeSet id="create block_time">
		<createTable tableName="block_time" remarks="optional information used to generate a caldav schedule">
			<column name="id" type="int">
				<constraints primaryKey="true" nullable="false" primaryKeyName="pk_block_time"/>
			</column>
			<column name="block_id">
				<constraints foreignKeyName="fk_block_time_block" references="block(id)"/>
			</column>
			<column name="effective_on" type="date" remarks="null means inherit from plan"/>
			<column name="expires_on" type="date" remarks="null means inherit from plan"/>
			<column name="day" type="smallint" remarks="0=sunday"/>
			<column name="start_at" type="time"/>
			<column name="end_at" type="time"/>
		</createTable>
	</changeSet>
	
	<changeSet id="create user" author="wj">
		<createTable tableName="users">
			<column name="uid" type="varchar(20)">
				<constraints primaryKey="true" nullable="false" primaryKeyName="pk_user"/>
			</column>
			<column name="credentials" type="varchar(255)"/>
		</createTable>
	</changeSet>
	
	<changeSet id="create role" author="wj">
		<createTable tableName="role">
			<column name="uid">
				<constraints nullable="false" foreignKeyName="fk_role_user" references="user(uid)"/>
			</column>
			<column name="role" type="varchar(255)">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>
	
	<changeSet id="insert administrator" author="wj">
		<insert tableName="user">
			<column name="uid" value="admin"/>
			<column name="credentials" value="password"/>
		</insert>
		<insert tableName="role">
			<column name="uid" value="admin"/>
			<column name="role" value="admin"/>
		</insert>
	</changeSet>

</databaseChangeLog>